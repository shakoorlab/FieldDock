{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nconst validReasonCodes = [0, 16, 128, 131, 135, 144, 145, 151, 153];\nconst handlePublish = (client, packet, done) => {\n  client.log('handlePublish: packet %o', packet);\n  done = typeof done !== 'undefined' ? done : client.noop;\n  let topic = packet.topic.toString();\n  const message = packet.payload;\n  const {\n    qos\n  } = packet;\n  const {\n    messageId\n  } = packet;\n  const {\n    options\n  } = client;\n  if (client.options.protocolVersion === 5) {\n    let alias;\n    if (packet.properties) {\n      alias = packet.properties.topicAlias;\n    }\n    if (typeof alias !== 'undefined') {\n      if (topic.length === 0) {\n        if (alias > 0 && alias <= 0xffff) {\n          const gotTopic = client['topicAliasRecv'].getTopicByAlias(alias);\n          if (gotTopic) {\n            topic = gotTopic;\n            client.log('handlePublish :: topic complemented by alias. topic: %s - alias: %d', topic, alias);\n          } else {\n            client.log('handlePublish :: unregistered topic alias. alias: %d', alias);\n            client.emit('error', new Error('Received unregistered Topic Alias'));\n            return;\n          }\n        } else {\n          client.log('handlePublish :: topic alias out of range. alias: %d', alias);\n          client.emit('error', new Error('Received Topic Alias is out of range'));\n          return;\n        }\n      } else if (client['topicAliasRecv'].put(topic, alias)) {\n        client.log('handlePublish :: registered topic: %s - alias: %d', topic, alias);\n      } else {\n        client.log('handlePublish :: topic alias out of range. alias: %d', alias);\n        client.emit('error', new Error('Received Topic Alias is out of range'));\n        return;\n      }\n    }\n  }\n  client.log('handlePublish: qos %d', qos);\n  switch (qos) {\n    case 2:\n      {\n        options.customHandleAcks(topic, message, packet, (error, code) => {\n          if (typeof error === 'number') {\n            code = error;\n            error = null;\n          }\n          if (error) {\n            return client.emit('error', error);\n          }\n          if (validReasonCodes.indexOf(code) === -1) {\n            return client.emit('error', new Error('Wrong reason code for pubrec'));\n          }\n          if (code) {\n            client['_sendPacket']({\n              cmd: 'pubrec',\n              messageId,\n              reasonCode: code\n            }, done);\n          } else {\n            client.incomingStore.put(packet, () => {\n              client['_sendPacket']({\n                cmd: 'pubrec',\n                messageId\n              }, done);\n            });\n          }\n        });\n        break;\n      }\n    case 1:\n      {\n        options.customHandleAcks(topic, message, packet, (error, code) => {\n          if (typeof error === 'number') {\n            code = error;\n            error = null;\n          }\n          if (error) {\n            return client.emit('error', error);\n          }\n          if (validReasonCodes.indexOf(code) === -1) {\n            return client.emit('error', new Error('Wrong reason code for puback'));\n          }\n          if (!code) {\n            client.emit('message', topic, message, packet);\n          }\n          client.handleMessage(packet, err => {\n            if (err) {\n              return done && done(err);\n            }\n            client['_sendPacket']({\n              cmd: 'puback',\n              messageId,\n              reasonCode: code\n            }, done);\n          });\n        });\n        break;\n      }\n    case 0:\n      client.emit('message', topic, message, packet);\n      client.handleMessage(packet, done);\n      break;\n    default:\n      client.log('handlePublish: unknown QoS. Doing nothing.');\n      break;\n  }\n};\nexports.default = handlePublish;","map":{"version":3,"names":["validReasonCodes","handlePublish","client","packet","done","log","noop","topic","toString","message","payload","qos","messageId","options","protocolVersion","alias","properties","topicAlias","length","gotTopic","getTopicByAlias","emit","Error","put","customHandleAcks","error","code","indexOf","cmd","reasonCode","incomingStore","handleMessage","err","exports","default"],"sources":["/Users/jstanton/Coding/FieldDock/FieldDockMain/node_modules/mqtt/src/lib/handlers/publish.ts"],"sourcesContent":["import { IPublishPacket } from 'mqtt-packet'\nimport { PacketHandler } from '../shared'\n\nconst validReasonCodes = [0, 16, 128, 131, 135, 144, 145, 151, 153]\n\n/*\n  those late 2 case should be rewrite to comply with coding style:\n\n  case 1:\n  case 0:\n    // do not wait sending a puback\n    // no callback passed\n    if (1 === qos) {\n      this._sendPacket({\n        cmd: 'puback',\n        messageId: messageId\n      });\n    }\n    // emit the message event for both qos 1 and 0\n    this.emit('message', topic, message, packet);\n    this.handleMessage(packet, done);\n    break;\n  default:\n    // do nothing but every switch mus have a default\n    // log or throw an error about unknown qos\n    break;\n\n  for now i just suppressed the warnings\n  */\nconst handlePublish: PacketHandler = (client, packet: IPublishPacket, done) => {\n\tclient.log('handlePublish: packet %o', packet)\n\tdone = typeof done !== 'undefined' ? done : client.noop\n\tlet topic = packet.topic.toString()\n\tconst message = packet.payload\n\tconst { qos } = packet\n\tconst { messageId } = packet\n\tconst { options } = client\n\tif (client.options.protocolVersion === 5) {\n\t\tlet alias: number\n\t\tif (packet.properties) {\n\t\t\talias = packet.properties.topicAlias\n\t\t}\n\t\tif (typeof alias !== 'undefined') {\n\t\t\tif (topic.length === 0) {\n\t\t\t\tif (alias > 0 && alias <= 0xffff) {\n\t\t\t\t\tconst gotTopic =\n\t\t\t\t\t\tclient['topicAliasRecv'].getTopicByAlias(alias)\n\t\t\t\t\tif (gotTopic) {\n\t\t\t\t\t\ttopic = gotTopic\n\t\t\t\t\t\tclient.log(\n\t\t\t\t\t\t\t'handlePublish :: topic complemented by alias. topic: %s - alias: %d',\n\t\t\t\t\t\t\ttopic,\n\t\t\t\t\t\t\talias,\n\t\t\t\t\t\t)\n\t\t\t\t\t} else {\n\t\t\t\t\t\tclient.log(\n\t\t\t\t\t\t\t'handlePublish :: unregistered topic alias. alias: %d',\n\t\t\t\t\t\t\talias,\n\t\t\t\t\t\t)\n\t\t\t\t\t\tclient.emit(\n\t\t\t\t\t\t\t'error',\n\t\t\t\t\t\t\tnew Error('Received unregistered Topic Alias'),\n\t\t\t\t\t\t)\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tclient.log(\n\t\t\t\t\t\t'handlePublish :: topic alias out of range. alias: %d',\n\t\t\t\t\t\talias,\n\t\t\t\t\t)\n\t\t\t\t\tclient.emit(\n\t\t\t\t\t\t'error',\n\t\t\t\t\t\tnew Error('Received Topic Alias is out of range'),\n\t\t\t\t\t)\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t} else if (client['topicAliasRecv'].put(topic, alias)) {\n\t\t\t\tclient.log(\n\t\t\t\t\t'handlePublish :: registered topic: %s - alias: %d',\n\t\t\t\t\ttopic,\n\t\t\t\t\talias,\n\t\t\t\t)\n\t\t\t} else {\n\t\t\t\tclient.log(\n\t\t\t\t\t'handlePublish :: topic alias out of range. alias: %d',\n\t\t\t\t\talias,\n\t\t\t\t)\n\t\t\t\tclient.emit(\n\t\t\t\t\t'error',\n\t\t\t\t\tnew Error('Received Topic Alias is out of range'),\n\t\t\t\t)\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t}\n\tclient.log('handlePublish: qos %d', qos)\n\tswitch (qos) {\n\t\tcase 2: {\n\t\t\toptions.customHandleAcks(\n\t\t\t\ttopic,\n\t\t\t\tmessage as Buffer,\n\t\t\t\tpacket,\n\t\t\t\t(error, code) => {\n\t\t\t\t\tif (typeof error === 'number') {\n\t\t\t\t\t\tcode = error\n\t\t\t\t\t\terror = null\n\t\t\t\t\t}\n\t\t\t\t\tif (error) {\n\t\t\t\t\t\treturn client.emit('error', error as Error)\n\t\t\t\t\t}\n\t\t\t\t\tif (validReasonCodes.indexOf(code) === -1) {\n\t\t\t\t\t\treturn client.emit(\n\t\t\t\t\t\t\t'error',\n\t\t\t\t\t\t\tnew Error('Wrong reason code for pubrec'),\n\t\t\t\t\t\t)\n\t\t\t\t\t}\n\t\t\t\t\tif (code) {\n\t\t\t\t\t\tclient['_sendPacket'](\n\t\t\t\t\t\t\t{ cmd: 'pubrec', messageId, reasonCode: code },\n\t\t\t\t\t\t\tdone,\n\t\t\t\t\t\t)\n\t\t\t\t\t} else {\n\t\t\t\t\t\tclient.incomingStore.put(packet, () => {\n\t\t\t\t\t\t\tclient['_sendPacket'](\n\t\t\t\t\t\t\t\t{ cmd: 'pubrec', messageId },\n\t\t\t\t\t\t\t\tdone,\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t)\n\t\t\tbreak\n\t\t}\n\t\tcase 1: {\n\t\t\t// emit the message event\n\t\t\toptions.customHandleAcks(\n\t\t\t\ttopic,\n\t\t\t\tmessage as Buffer,\n\t\t\t\tpacket,\n\t\t\t\t(error, code) => {\n\t\t\t\t\tif (typeof error === 'number') {\n\t\t\t\t\t\tcode = error\n\t\t\t\t\t\terror = null\n\t\t\t\t\t}\n\t\t\t\t\tif (error) {\n\t\t\t\t\t\treturn client.emit('error', error as Error)\n\t\t\t\t\t}\n\t\t\t\t\tif (validReasonCodes.indexOf(code) === -1) {\n\t\t\t\t\t\treturn client.emit(\n\t\t\t\t\t\t\t'error',\n\t\t\t\t\t\t\tnew Error('Wrong reason code for puback'),\n\t\t\t\t\t\t)\n\t\t\t\t\t}\n\t\t\t\t\tif (!code) {\n\t\t\t\t\t\tclient.emit('message', topic, message as Buffer, packet)\n\t\t\t\t\t}\n\t\t\t\t\tclient.handleMessage(packet, (err) => {\n\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\treturn done && done(err)\n\t\t\t\t\t\t}\n\t\t\t\t\t\tclient['_sendPacket'](\n\t\t\t\t\t\t\t{ cmd: 'puback', messageId, reasonCode: code },\n\t\t\t\t\t\t\tdone,\n\t\t\t\t\t\t)\n\t\t\t\t\t})\n\t\t\t\t},\n\t\t\t)\n\t\t\tbreak\n\t\t}\n\t\tcase 0:\n\t\t\t// emit the message event\n\t\t\tclient.emit('message', topic, message as Buffer, packet)\n\t\t\tclient.handleMessage(packet, done)\n\t\t\tbreak\n\t\tdefault:\n\t\t\t// do nothing\n\t\t\tclient.log('handlePublish: unknown QoS. Doing nothing.')\n\t\t\t// log or throw an error about unknown qos\n\t\t\tbreak\n\t}\n}\n\nexport default handlePublish\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}